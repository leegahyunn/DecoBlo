<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.decoblog.www.blog.dao.BlogMapper">

<!-- 메뉴 가져오는 result map -->
<resultMap id="selectMap" type="java.util.HashMap">
	<id column="menuParent" property="menuParent"/>
	<collection property="Menu" javaType="java.util.ArrayList" resultMap="menus" />
</resultMap>

<resultMap type="Menu" id="menus">
	<result property="menuNo" column="menuNo"/>
	<result property="menuName" column="menuName"/>
	<result property="menuParent" column="menuParent"/>
	<result property="menuDepth" column="menuDepth"/>
	<result property="menuSeq" column="menuSeq"/>
	<result property="menuVisible" column="menuVisible"/>
	<result property="menuLink" column="menuLink"/>
	<result property="menuParentSeq" column="menuParentSeq"/>
</resultMap>

<!-- 블로그 기본 정보 가져오기 -->
<!-- public User selectBlogBasicInfo(String userNo)  -->
<select id="selectBlogBasicInfo" parameterType="String" resultType="User">
	SELECT
	    userNo, blogTitle, blogAddress,
	    configRightClickable, configBasicFont, configBackgroundColor,
	    configBackgroundSavedFile, fabiconSavedFile,
	    metaAuthor, metaKeyword, metaDescription, configOnePageStyle
	FROM
	    db_user
	WHERE
	    userNo = #{userNo}
</select>

<!-- 메뉴 가져오기 -->
<select id="selectMenu" parameterType="int" resultMap="selectMap">
	SELECT 
		*
	FROM
		db_menu
	WHERE
		menuUserNo = #{userNo}
	ORDER BY 
		menuparentseq, menuseq
	
</select>

<insert id="insertMenu" parameterType="map">
   insert into db_menu
         (
         menuNo
         ,menuUserNo
         ,menuName
         ,menuParent
         ,menuDepth
         ,menuSeq
         ,menuVisible
         ,menuParentSeq
         )
   values( 
      db_menu_seq.nextval
      , #{menuUserNo}
      , #{menuName}
      , db_menu_seq.nextval
      , 0
      , 0
      , 1
      ,(select Max(menuparentseq)+1 from db_menu where menuUserNo=#{menuUserNo})
   )
</insert>
<!-- 블록 넘버 가져오기 -->
<select id="selectThumnail" parameterType="string" resultType="int">
	SELECT blocktmpno FROM DB_BLOCK_TEMPLATE WHERE blocktmptype=#{tmpType}
</select>

<update id="updateMenuTitle" parameterType="Menu">
	UPDATE 
		db_menu
	SET
		menuName = #{menuName}
	WHERE
		menuNo = #{menuNo}
</update>
<update id="updateSmallMenuPush" parameterType="map">
	UPDATE 
		db_menu
	SET
		menuSeq = menuSeq + 1
	WHERE
		menuSeq >= #{newMenuSeq}
	AND 
		menuParent = #{newMenuParent}
	AND
		menuUserNo = #{menuUserNo}
</update>
<update id="updateSmallMenuPull" parameterType="map">
	UPDATE 
		db_menu
	SET
		menuSeq = menuSeq - 1
	WHERE
		menuSeq > #{menuSeq}
	AND 
		menuParent = #{menuParent}
	AND
		menuUserNo = #{menuUserNo}
</update>

<update id="updateLargeMenuPush" parameterType="map">
	UPDATE 
		db_menu
	SET
		menuParentSeq = menuParentSeq + 1
	WHERE
		menuParentSeq >= #{newMenuSeq}
	AND
		menuUserNo = #{menuUserNo}
		
</update>
<update id="updateLargeMenuPull" parameterType="map">
	UPDATE 
		db_menu
	SET
		menuParentSeq = menuParentSeq - 1
	WHERE
		menuParentSeq > #{menuParentSeq}
	AND
		menuUserNo = #{menuUserNo}
</update>

<update id="updateMenu" parameterType="map">
	UPDATE 
		db_menu
	SET
		<if test="newMenuDepth==0">
			menuSeq = 0,
			menuParent = #{menuNo},
			menuParentSeq = #{newMenuSeq},
		</if>
		<if test="newMenuDepth!=0">
			menuSeq = #{newMenuSeq},
			menuParent = #{newMenuParent},
			menuParentSeq = (SELECT menuParentSeq FROM db_menu WHERE menuNo=#{newMenuParent}),
		</if>
		menuDepth = #{newMenuDepth}
	WHERE
		menuNo = #{menuNo}
</update>
<update id="updateSubmenu" parameterType="map">
	UPDATE 
		db_menu
	SET
		menuParentSeq = (select menuParentSeq from db_menu where menuParent=#{newMenuParent} and menudepth=0)
	WHERE
		menuParent = #{menuNo}
</update>
<!-- 블로그 타이틀 수정 -->
<update id="updateBlogTitle" parameterType="map">
	UPDATE 
		db_user
	SET
		blogTitle = #{blogTitle}
	WHERE
		userNo = #{userNo}
</update>
<!-- 블로그 메타태그 수정 -->
<update id="updateMetaTag" parameterType="map">
	UPDATE 
		db_user
	SET
		metaAuthor = #{metaAuthor},
		metaKeyword = #{metaKeyword},
		metaDescription = #{metaDescription}
	WHERE
		userNo = #{userNo}
</update>
<!-- 블로그 메타태그 수정 -->
<update id="updateBackgroundColor" parameterType="map">
	UPDATE 
		db_user
	SET
		configBackgroundColor = #{configBackgroundColor}
	WHERE
		userNo = #{userNo}
</update>
<update id="updateBlogFont" parameterType="map">
	UPDATE 
		db_user
	SET
		configBasicFont = #{configBasicFont}
	WHERE
		userNo = #{userNo}
</update>
<update id="updateOnepageStyle" parameterType="map">
	UPDATE 
		db_user
	SET
		configOnepageStyle = #{configOnepageStyle}
	WHERE
		userNo = #{userNo}
</update>
<update id="updateRightClickable" parameterType="map">
	UPDATE 
		db_user
	SET
		configRightClickable = #{configRightClickable}
	WHERE
		userNo = #{userNo}
</update>
<update id="updateMenuVisible" parameterType="map">
	UPDATE 
		db_menu
	SET
		menuVisible = #{menuVisible}
	WHERE
		menuUserNo = #{menuUserNo}
	AND
		menuNo = #{menuNo}
</update>
<!-- 배경 이미지 -->
<update id="updateBackgroundImg" parameterType="map">
	UPDATE 
		db_user
	SET
		configBackgroundOriginFile = #{configBackgroundOriginFile},
		configBackgroundSavedFile = #{configBackgroundSavedFile}
	WHERE
		userNo = #{userNo}
</update>
<!-- 파비콘 이미지 -->
<update id="updateFabiconImg" parameterType="map">
	UPDATE 
		db_user
	SET
		fabiconOriginalFile = #{fabiconOriginalFile},
		fabiconSavedFile = #{fabiconSavedFile}
	WHERE
		userNo = #{userNo}
</update>
<!-- 사이트설정 가져오기 -->
<select id="selectBlog" resultType="User" parameterType="int">
	SELECT 
		*
	FROM
		db_user
	WHERE
		userNo = #{userNo}
</select>
<!-- 메뉴 삭제 -->
<delete id="deleteSmallMenu" parameterType="map">
	delete from db_menu
	where
		menuNo = #{menuNo} 
</delete>
<delete id="deleteLargeMenu" parameterType="map">
	delete from db_menu
	where
		menuParent = #{menuParent} 
</delete>
<!-- 블록 코드 가져오기 썸네일 -->
<select id="selectBlockContent" parameterType="int" resultType="string">
SELECT blockTmpContent FROM db_block_template
 WHERE blocktmpno =#{blocktmpNo}
 </select>
 
 <!-- 블록 가져오기 메뉴 -->
 <select id="selectBlockList" parameterType="Menu" resultType="Block">
 SELECT blockno,blockmenuno, blockContent,blockseq,blocktmpno,blockcss
FROM db_block,db_menu,db_user
WHERE db_block.blockmenuno=db_menu.menuno AND db_menu.menuno=#{menuNo}
AND db_menu.menuuserno = db_user.userno AND db_user.userno=#{menuUserNo}
ORDER BY blockseq
 </select> 
 
  
 <!-- 블록 입력 -->
<insert id="insertBlock" parameterType="Block">
INSERT INTO db_block(blockno,blockmenuno,blocktmpno,blockseq,blockcontent)
 VALUES(
(select max(blockNo)+1 from db_block),#{blockMenuNo},#{blockTmpNo},#{blockSeq},
#{blockContent}
)
</insert>
<!-- 블록 복제 -->
<insert id="copyBlock" parameterType="int">
INSERT 
INTO db_block (
    blockNo, blockMenuNo, blockTmpNo, 
    blockSeq, blockContent, blockBackgroundNo, blockCss
) (
    SELECT 
        (select max(blockNo)+1 from db_block), blockMenuNo, blockTmpNo, 
        blockSeq-1, blockContent, blockBackgroundNo, blockCss  
    FROM db_block 
    WHERE blockno = #{blockNo}
)
</insert>

<!-- 블록 Seq 한자리씩 미루기 -->
<update id="updateBlockSeq" parameterType="int">
UPDATE db_block SET blockseq = blockseq+1 WHERE blockseq >= #{blockSeq}
</update>
<!-- 블럭 삭제 -->
<delete id="deleteBlock" parameterType="int">
DELETE db_block WHERE blockseq=#{blockSeq}
</delete>
<!-- 블록 css 저장  -->
<update id="insertBlockCss" parameterType="Block">
UPDATE db_block SET blockcss = #{blockCss} WHERE blockNo = #{blockNo}
</update>
<!-- 첫번 째 메뉴 가져오기 -->
<select id="selectFirstMenu" parameterType="int" resultType="Menu">
SELECT * FROM db_menu
WHERE menuuserno = #{userNo} AND menuparentseq=1
</select>
<!-- 메뉴 하나 가져오기 -->
<select id="selectOneMenu" parameterType="Menu" resultType="Menu">
SELECT * FROM db_menu
WHERE menuNo=#{menuNo} AND menuuserno=#{menuUserNo}
</select>

<!-- 템플릿 전체 가져오기 -->
<!-- public Template selectTemplate(); -->
<select id="selectTemplate" resultType="Template">
	SELECT 
		templateNo, templateTitle, templateMenu
	FROM
		db_template
</select>

<!-- 메뉴 번호 가져오기 -->
<!-- public ArrayList<Integer> selectMenuNo(String userNo); -->
<select id="selectMenuNo" parameterType="String" resultType="Integer">
	SELECT
		menuNo
	FROM
		db_menu
	WHERE
		menuUserNo = #{userNo}
	ORDER BY
		menuParentSeq, menuSeq
</select>

<!-- 블럭 가져오기 -->
<!-- public ArrayList<Block> selectBlock(int menuNo); -->
<select id="selectBlock" parameterType="Integer" resultType="Block">
	SELECT
	    blockNo, blockSeq, blockBackgroundNo, blockContent, blockCss
	FROM 
	    db_block
	WHERE
	    blockMenuNo = #{menuNo}
	ORDER BY
	    blockSeq
</select>

<!-- 유저번호 가져오기 -->
<!-- public String selectUserNoByBlogTitle(String blogTitle); -->
<select id="selectUserNoByBlogAddress" parameterType="String" resultType="String">
	SELECT
		userNo
	FROM 
		db_user
	WHERE
		blogAddress = #{blogAddress}
</select>

<!-- 템플릿 메뉴 가져오기 -->
<!-- public String selectTemplateMenu(String templateNo); -->
<select id="selectTemplateMenu" parameterType="String" resultType="String">
	SELECT
	    templateMenu
	FROM
	    db_template
	WHERE
	    templateNo = #{templateNo}
</select>

<!-- 메인 메뉴 삽입 후 Seq 가져오기 -->
<!-- public int insertMainMenu(Menu mainMenu); -->
<insert id="insertMainMenu" parameterType="Menu">
	<selectKey keyProperty="menuNo" resultType="int" order="AFTER">
		SELECT 
			db_menu_seq.CURRVAL 
		FROM
			DUAL
	</selectKey>
	
	INSERT INTO db_menu (
		menuNo, menuUserNo, menuName, menuParent, 
		menuDepth, menuSeq, menuVisible, menuLink, menuParentSeq
	) VALUES (
		db_menu_seq.NEXTVAL, #{menuUserNo}, #{menuName}, db_menu_seq.NEXTVAL,
		#{menuDepth}, #{menuSeq}, #{menuVisible}, #{menuLink}, #{menuParentSeq}
	)
</insert>

<!-- 서브 메뉴 삽입 -->
<!-- public int insertSubMenu(Menu mainMenu); -->
<insert id="insertSubMenu" parameterType="Menu">
	INSERT INTO db_menu (
		menuNo, menuUserNo, menuName, menuParent, 
		menuDepth, menuSeq, menuVisible, menuLink, menuParentSeq
	) VALUES (
		db_menu_seq.NEXTVAL, #{menuUserNo}, #{menuName}, #{menuParent},
		#{menuDepth}, #{menuSeq}, #{menuVisible}, #{menuLink}, #{menuParentSeq}
	)
</insert>

<!-- 블럭 템플릿 복사 -->
<!-- public int pasteBlock(Map<String, String> insertData); -->
<insert id="pasteBlock" parameterType="HashMap">
	INSERT INTO db_block (
		blockNo, blockMenuNo, blockTmpNo, blockSeq, blockContent
	)
	SELECT 
	    (SELECT MAX(blockNo) FROM db_block) + blockTmpNo - (
	    	SELECT 
	    		MIN(blockTmpNo) 
	    	FROM 
	    		db_block_template 
	    	WHERE 
	    		blockTemplateNo = #{blockTmpNo}
	    ) + 1, #{blockMenuNo}, #{blockTmpNo}, 
	    blockTmpNo - (
	    	SELECT 
	    		MIN(blockTmpNo) 
	    	FROM 
	    		db_block_template 
	    	WHERE 
	    		blockTemplateNo = #{blockTmpNo}
	    ) + 1, blockTmpContent
	FROM 
	    db_block_template
	WHERE        
	    blockTemplateNo = #{blockTmpNo}
	ORDER BY
	    blockTmpNo
</insert>

<!-- 블로그 주소 변경 -->
<!-- public int updateBlogAddress(Map<String, String> insertData); -->
<update id="updateBlogAddress" parameterType="HashMap">
	UPDATE
		db_user
	SET
		blogAddress = #{address}
	WHERE
		userNo = #{userNo}
</update>
<!-- 블록 컨텐트 텍스트 수정 -->
<update id="updateBlockContentText" parameterType="Block">
	UPDATE db_block SET blockcontent = #{blockContent}
	WHERE blockseq = ${blockSeq}
</update>
</mapper>